rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================================================
    // HELPER FUNCTIONS
    // ========================================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isActive() {
      return isAuthenticated() && userExists() && getUserData().isActive == true;
    }
    
    // ========================================================================
    // PERMISSION CHECKS
    // ========================================================================
    
    function hasPermission(permission) {
      return isActive() && permission in getUserData().permissions;
    }
    
    function hasAnyPermission(permissions) {
      return isActive() && getUserData().permissions.hasAny(permissions);
    }
    
    function hasWildcard(resource) {
      return isActive() && (
        ('*.*' in getUserData().permissions) ||
        (resource + '.*' in getUserData().permissions)
      );
    }
    
    function canRead(resource) {
      return hasWildcard(resource) || 
             hasPermission(resource + '.read') || 
             hasPermission('*.read');
    }
    
    function canWrite(resource) {
      return hasWildcard(resource) || 
             hasPermission(resource + '.write') || 
             hasPermission('*.write');
    }
    
    function canDelete(resource) {
      return hasWildcard(resource) || 
             hasPermission(resource + '.delete');
    }
    
    // ========================================================================
    // CONTEXT CHECKS
    // ========================================================================
    
    function isSuperAdmin() {
      return hasPermission('*.*');
    }
    
    function sameClub(clubId) {
      return isSuperAdmin() || getUserData().clubId == clubId;
    }
    
    function inMyTeams(teamId) {
      return isSuperAdmin() || 
             (sameClub(get(/databases/$(database)/documents/teams/$(teamId)).data.clubId)) ||
             (teamId in getUserData().teamIds);
    }
    
    function isMyPlayer(playerId) {
      return isSuperAdmin() || 
             (playerId in getUserData().playerIds);
    }
    
    // ========================================================================
    // USERS COLLECTION
    // ========================================================================
    
    match /users/{userId} {
      // Każdy zalogowany może czytać swój własny profil
      allow read: if isOwner(userId);
      
      // Każdy zalogowany może aktualizować swoje podstawowe dane (ale nie permissions!)
      allow update: if isOwner(userId) && 
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny([
          'permissions', 'rolePreset', 'isActive', 'clubId'
        ]));
      
      // Users.read permission pozwala czytać użytkowników
      allow read: if canRead('users');
      
      // Users.write permission pozwala tworzyć/edytować użytkowników
      allow create: if canWrite('users');
      allow update: if canWrite('users');
      
      // Users.delete permission pozwala usuwać użytkowników
      allow delete: if canDelete('users');
    }
    
    // ========================================================================
    // CLUBS COLLECTION
    // ========================================================================
    
    match /clubs/{clubId} {
      // Clubs.read permission
      allow read: if canRead('clubs');
      
      // Clubs.write permission
      allow create: if canWrite('clubs');
      allow update: if canWrite('clubs') && sameClub(clubId);
      
      // Clubs.delete permission (tylko superadmin)
      allow delete: if canDelete('clubs') && isSuperAdmin();
    }
    
    // ========================================================================
    // TEAMS COLLECTION
    // ========================================================================
    
    match /teams/{teamId} {
      // Teams.read permission
      allow read: if canRead('teams');
      
      // Teams.write permission (w swoim klubie)
      allow create: if canWrite('teams') && sameClub(request.resource.data.clubId);
      allow update: if canWrite('teams') && sameClub(resource.data.clubId);
      
      // Teams.delete permission
      allow delete: if canDelete('teams');
    }
    
    // ========================================================================
    // PLAYERS COLLECTION
    // ========================================================================
    
    match /players/{playerId} {
      // Players.read permission
      // Parent może czytać tylko swoje dzieci
      allow read: if canRead('players') && (
        isSuperAdmin() || 
        sameClub(resource.data.clubId) ||
        inMyTeams(resource.data.teamId) ||
        isMyPlayer(playerId)
      );
      
      // Players.write permission
      allow create: if canWrite('players') && sameClub(request.resource.data.clubId);
      allow update: if canWrite('players') && (
        isSuperAdmin() ||
        sameClub(resource.data.clubId) ||
        inMyTeams(resource.data.teamId) ||
        (isMyPlayer(playerId) && onlyUpdatingAllowedFields())
      );
      
      // Players.delete permission
      allow delete: if canDelete('players');
    }
    
    function onlyUpdatingAllowedFields() {
      // Parent może edytować tylko notes i medicalInfo
      return !request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['name', 'dateOfBirth', 'teamId', 'clubId', 'parentIds', 'isActive']);
    }
    
    // ========================================================================
    // BOOKINGS COLLECTION
    // ========================================================================
    
    match /bookings/{bookingId} {
      // Publiczny odczyt (dla kalendarza dostępności)
      allow read: if true;
      
      // Bookings.write permission
      allow create: if canWrite('bookings');
      allow update: if canWrite('bookings');
      
      // Bookings.delete permission
      allow delete: if canDelete('bookings');
      
      // Bookings.approve permission (zmiana statusu)
      allow update: if hasPermission('bookings.approve') && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']);
    }
    
    // ========================================================================
    // FIELDS COLLECTION
    // ========================================================================
    
    match /fields/{fieldId} {
      // Publiczny odczyt listy boisk
      allow read: if true;
      
      // Fields.write permission
      allow create: if canWrite('fields');
      allow update: if canWrite('fields');
      
      // Fields.delete permission
      allow delete: if canDelete('fields');
    }
    
    // ========================================================================
    // ATTENDANCE COLLECTION (V2 - future)
    // ========================================================================
    
    match /attendance/{attendanceId} {
      // Attendance.read permission
      allow read: if canRead('attendance');
      
      // Attendance.write permission
      allow create: if canWrite('attendance');
      allow update: if canWrite('attendance');
      
      allow delete: if canDelete('attendance');
    }
    
    // ========================================================================
    // PAYMENTS COLLECTION (V2 - future)
    // ========================================================================
    
    match /payments/{paymentId} {
      // Payments.read permission
      allow read: if canRead('payments');
      
      // Payments.write permission
      allow create: if canWrite('payments');
      allow update: if canWrite('payments');
      
      // Payments.refund permission
      allow update: if hasPermission('payments.refund') &&
        request.resource.data.status == 'refunded';
      
      allow delete: if canDelete('payments');
    }
    
    // ========================================================================
    // NOTIFICATIONS COLLECTION
    // ========================================================================
    
    match /notifications/{notificationId} {
      // Użytkownik może czytać tylko swoje notyfikacje
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Użytkownik może oznaczać swoje notyfikacje jako przeczytane
      allow update: if isAuthenticated() && isOwner(resource.data.userId) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      
      // Tylko system może tworzyć notyfikacje
      allow create: if false;
      
      // Użytkownik może usuwać swoje notyfikacje
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // ========================================================================
    // PENDING USERS COLLECTION
    // ========================================================================
    
    match /pendingUsers/{pendingId} {
      // Users.write permission może zarządzać oczekującymi użytkownikami
      allow read: if canRead('users');
      allow create: if canWrite('users');
      allow update, delete: if canWrite('users');
    }
    
    // ========================================================================
    // PASSWORD RESETS COLLECTION (logs)
    // ========================================================================
    
    match /passwordResets/{resetId} {
      // Wszyscy zalogowani mogą czytać logi
      allow read: if isAuthenticated();
      
      // Cloud Function może zapisywać
      allow create: if isAuthenticated();
    }
    
    // ========================================================================
    // SETTINGS COLLECTION (club settings)
    // ========================================================================
    
    match /settings/{settingId} {
      // Clubs.settings permission
      allow read: if hasPermission('clubs.read');
      allow write: if hasPermission('clubs.settings');
    }
  }
}
